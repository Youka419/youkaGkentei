<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’ - Gæ¤œå®š å­¦ç¿’ã‚¢ãƒ—ãƒª</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .review-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        
        .review-header {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .review-header h1 {
            color: white;
            margin-bottom: 10px;
        }
        
        .review-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .review-stat {
            text-align: center;
        }
        
        .review-stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .review-stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .review-controls {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .review-controls button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        
        .review-controls button:hover {
            background: #5568d3;
        }
        
        .review-controls button.secondary {
            background: #4caf50;
        }
        
        .review-controls button.secondary:hover {
            background: #45a049;
        }
        
        .review-controls button.danger {
            background: #f44336;
        }
        
        .review-controls button.danger:hover {
            background: #d32f2f;
        }
        
        .review-mode-badge {
            display: inline-block;
            background: #ff9800;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .no-wrong-questions {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .no-wrong-questions h2 {
            color: #4caf50;
            margin-bottom: 15px;
        }
        
        .question.review-mode {
            border: 3px solid #f44336;
        }
        
        .question.review-mode.correct-now {
            border-color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="review-container">
        <a href="index.html" class="back-link">â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
        <a href="history.html" class="back-link" style="margin-left: 15px;">â† å­¦ç¿’å±¥æ­´ã«æˆ»ã‚‹</a>
        
        <div class="review-header">
            <h1>ğŸ“š é–“é•ãˆãŸå•é¡Œã‚’å¾©ç¿’</h1>
            <p>éå»ã«é–“é•ãˆãŸå•é¡Œã‚’é›†ä¸­çš„ã«å¾©ç¿’ã§ãã¾ã™</p>
            <div class="review-stats" id="reviewStats">
                <!-- çµ±è¨ˆæƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
        
        <div class="review-controls">
            <button onclick="shuffleQuestions()" class="secondary">ğŸ”€ å•é¡Œã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«</button>
            <button onclick="resetReviewAnswers()" class="danger">ğŸ”„ å›ç­”ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            <span class="review-mode-badge">å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰</span>
        </div>
        
        <div id="reviewQuestionsContainer">
            <!-- é–“é•ãˆãŸå•é¡ŒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
    </div>
    
    <script src="script.js"></script>
    <script>
        const categoryNames = {
            'category1': 'â‘  äººå·¥çŸ¥èƒ½ã¨ã¯',
            'category2': 'â‘¡ äººå·¥çŸ¥èƒ½ã‚’ã‚ãã‚‹å‹•å‘',
            'category3': 'â‘¢ æ©Ÿæ¢°å­¦ç¿’ã®æ¦‚è¦',
            'category4': 'â‘£ ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ã®æ¦‚è¦',
            'category5': 'â‘¤ ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ã®è¦ç´ æŠ€è¡“',
            'category6': 'â‘¥ ãƒ‡ã‚£ãƒ¼ãƒ—ãƒ©ãƒ¼ãƒ‹ãƒ³ã‚°ã®å¿œç”¨ä¾‹',
            'category7': 'â‘¦ AIã®ç¤¾ä¼šå®Ÿè£…ã«å‘ã‘ã¦',
            'category8': 'â‘§ AIã«å¿…è¦ãªæ•°ç†ãƒ»çµ±è¨ˆçŸ¥è­˜',
            'category9': 'â‘¨ AIã«é–¢ã™ã‚‹æ³•å¾‹ã¨å¥‘ç´„',
            'category10': 'â‘© AIå€«ç†ãƒ»AIã‚¬ãƒãƒŠãƒ³ã‚¹'
        };
        
        let wrongQuestions = [];
        let currentQuestions = [];
        
        // é–“é•ãˆãŸå•é¡Œã‚’èª­ã¿è¾¼ã‚€
        function loadWrongQuestions() {
            const history = StudyHistory.getHistory();
            wrongQuestions = [];
            
            Object.keys(history).forEach(category => {
                if (history[category] && history[category].questions) {
                    history[category].questions.forEach((question, index) => {
                        if (question && !question.isCorrect) {
                            wrongQuestions.push({
                                category: category,
                                categoryName: categoryNames[category] || category,
                                questionIndex: index,
                                selectedAnswer: question.selectedAnswer,
                                correctAnswer: question.correctAnswer,
                                timestamp: question.timestamp
                            });
                        }
                    });
                }
            });
            
            // æœ€æ–°ã®é–“é•ã„ã‹ã‚‰é †ã«è¡¨ç¤º
            wrongQuestions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            currentQuestions = [...wrongQuestions];
            
            updateStats();
            displayQuestions();
        }
        
        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        function updateStats() {
            const statsDiv = document.getElementById('reviewStats');
            const totalWrong = wrongQuestions.length;
            const reviewed = wrongQuestions.filter(q => {
                const history = StudyHistory.getHistory();
                if (history[q.category] && history[q.category].questions[q.questionIndex]) {
                    return history[q.category].questions[q.questionIndex].isCorrect;
                }
                return false;
            }).length;
            
            statsDiv.innerHTML = `
                <div class="review-stat">
                    <div class="review-stat-number">${totalWrong}</div>
                    <div class="review-stat-label">é–“é•ãˆãŸå•é¡Œæ•°</div>
                </div>
                <div class="review-stat">
                    <div class="review-stat-number">${reviewed}</div>
                    <div class="review-stat-label">å¾©ç¿’æ¸ˆã¿ï¼ˆæ­£è§£ï¼‰</div>
                </div>
                <div class="review-stat">
                    <div class="review-stat-number">${totalWrong - reviewed}</div>
                    <div class="review-stat-label">æ®‹ã‚Š</div>
                </div>
            `;
        }
        
        // å•é¡Œã‚’è¡¨ç¤º
        function displayQuestions() {
            const container = document.getElementById('reviewQuestionsContainer');
            
            if (currentQuestions.length === 0) {
                container.innerHTML = `
                    <div class="no-wrong-questions">
                        <h2>ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼</h2>
                        <p>é–“é•ãˆãŸå•é¡Œã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã™ã¹ã¦æ­£è§£ã§ãã¦ã„ã¾ã™ï¼</p>
                        <a href="index.html" class="history-link" style="display: inline-block; margin-top: 20px;">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
                    </div>
                `;
                return;
            }
            
            let html = '';
            currentQuestions.forEach((item, idx) => {
                html += `
                    <div class="question review-mode" id="review-question-${idx}" data-category="${item.category}" data-index="${item.questionIndex}">
                        <div style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px; font-size: 0.9em;">
                            <strong>${item.categoryName}</strong> - å•é¡Œ #${item.questionIndex + 1} | 
                            å‰å›ã®å›ç­”: <span style="color: #f44336; font-weight: bold;">${item.selectedAnswer}</span> | 
                            æ­£è§£: <span style="color: #4caf50; font-weight: bold;">${item.correctAnswer}</span>
                        </div>
                        <div class="question-text" id="question-text-${idx}">
                            <!-- å•é¡Œæ–‡ãŒã“ã“ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                        </div>
                        <ul class="options" id="options-${idx}">
                            <!-- é¸æŠè‚¢ãŒã“ã“ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                        </ul>
                        <button class="answer-btn" onclick="checkReviewAnswer(this, ${idx}, '${item.correctAnswer}')">ç­”ãˆã‚’ç¢ºèª</button>
                        <div class="result" id="result-${idx}">
                            <!-- çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // å„å•é¡Œã‚’èª­ã¿è¾¼ã‚€
            currentQuestions.forEach((item, idx) => {
                loadQuestionContent(item.category, item.questionIndex, idx);
            });
        }
        
        // å•é¡Œã®å†…å®¹ã‚’èª­ã¿è¾¼ã‚€
        function loadQuestionContent(category, questionIndex, displayIndex) {
            fetch(`${category}.html`)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const questions = doc.querySelectorAll('.question');
                    
                    if (questions[questionIndex]) {
                        const question = questions[questionIndex];
                        const questionText = question.querySelector('.question-text');
                        const options = question.querySelectorAll('.options li');
                        const result = question.querySelector('.result');
                        
                        // å•é¡Œæ–‡ã‚’è¡¨ç¤º
                        const questionTextDiv = document.getElementById(`question-text-${displayIndex}`);
                        if (questionTextDiv && questionText) {
                            questionTextDiv.innerHTML = questionText.innerHTML;
                        }
                        
                        // é¸æŠè‚¢ã‚’è¡¨ç¤º
                        const optionsUl = document.getElementById(`options-${displayIndex}`);
                        if (optionsUl) {
                            optionsUl.innerHTML = '';
                            options.forEach(option => {
                                const li = document.createElement('li');
                                li.setAttribute('data-option', option.getAttribute('data-option'));
                                li.textContent = option.textContent;
                                li.addEventListener('click', function() {
                                    const questionEl = this.closest('.question');
                                    questionEl.querySelectorAll('.options li').forEach(li => {
                                        li.classList.remove('selected');
                                    });
                                    this.classList.add('selected');
                                });
                                optionsUl.appendChild(li);
                            });
                        }
                        
                        // çµæœã‚’è¡¨ç¤ºï¼ˆæ—¢ã«å›ç­”æ¸ˆã¿ã®å ´åˆï¼‰
                        const history = StudyHistory.getHistory();
                        if (history[category] && history[category].questions[questionIndex]) {
                            const questionData = history[category].questions[questionIndex];
                            if (questionData.answered) {
                                const resultDiv = document.getElementById(`result-${displayIndex}`);
                                const questionEl = document.getElementById(`review-question-${displayIndex}`);
                                
                                if (resultDiv && result) {
                                    resultDiv.innerHTML = result.innerHTML;
                                    resultDiv.style.display = 'block';
                                    if (questionData.isCorrect) {
                                        resultDiv.classList.add('correct');
                                        resultDiv.classList.remove('incorrect');
                                        questionEl.classList.add('correct-now');
                                    } else {
                                        resultDiv.classList.add('incorrect');
                                        resultDiv.classList.remove('correct');
                                    }
                                }
                                
                                // é¸æŠè‚¢ã®è‰²ã‚’è¨­å®š
                                const options = questionEl.querySelectorAll('.options li');
                                options.forEach(option => {
                                    const optionValue = option.getAttribute('data-option');
                                    if (optionValue === questionData.correctAnswer) {
                                        option.classList.add('correct');
                                    } else if (optionValue === questionData.selectedAnswer && !questionData.isCorrect) {
                                        option.classList.add('incorrect');
                                    }
                                });
                                
                                // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                                const button = questionEl.querySelector('.answer-btn');
                                if (button) {
                                    button.disabled = true;
                                    button.style.opacity = '0.6';
                                    button.textContent = questionData.isCorrect ? 'âœ“ æ­£è§£ã—ã¾ã—ãŸï¼' : 'âœ— ä¸æ­£è§£';
                                }
                            }
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading question:', error);
                });
        }
        
        // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã®å›ç­”ç¢ºèª
        function checkReviewAnswer(button, displayIndex, correctAnswer) {
            const question = button.closest('.question');
            const selected = question.querySelector('.options li.selected');
            const result = question.querySelector('.result');
            const options = question.querySelectorAll('.options li');
            
            if (!selected) {
                alert('é¸æŠè‚¢ã‚’é¸ã‚“ã§ãã ã•ã„');
                return;
            }
            
            const selectedAnswer = selected.getAttribute('data-option');
            const isCorrect = selectedAnswer === correctAnswer;
            const category = question.getAttribute('data-category');
            const questionIndex = parseInt(question.getAttribute('data-index'));
            
            // å­¦ç¿’å±¥æ­´ã«è¨˜éŒ²
            StudyHistory.recordAnswer(category, questionIndex, isCorrect, selectedAnswer, correctAnswer);
            
            // å•é¡Œå…¨ä½“ã®èƒŒæ™¯è‰²ã‚’å¤‰æ›´
            question.classList.remove('answered-correct', 'answered-incorrect');
            if (isCorrect) {
                question.classList.add('answered-correct', 'correct-now');
            } else {
                question.classList.add('answered-incorrect');
            }
            
            // é¸æŠè‚¢ã®è‰²ã‚’å¤‰æ›´
            options.forEach(option => {
                option.classList.remove('correct', 'incorrect', 'selected');
                const optionValue = option.getAttribute('data-option');
                if (optionValue === correctAnswer) {
                    option.classList.add('correct');
                } else if (optionValue === selectedAnswer && selectedAnswer !== correctAnswer) {
                    option.classList.add('incorrect');
                }
            });
            
            // ç­”ãˆã‚’è¡¨ç¤º
            result.style.display = 'block';
            if (isCorrect) {
                result.classList.add('correct');
                result.classList.remove('incorrect');
            } else {
                result.classList.add('incorrect');
                result.classList.remove('correct');
            }
            
            // å•é¡Œã®èª¬æ˜ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
            fetch(`${category}.html`)
                .then(response => response.text())
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const questions = doc.querySelectorAll('.question');
                    if (questions[questionIndex]) {
                        const originalResult = questions[questionIndex].querySelector('.result');
                        if (originalResult) {
                            result.innerHTML = originalResult.innerHTML;
                        }
                    }
                });
            
            // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            button.disabled = true;
            button.style.opacity = '0.6';
            button.textContent = isCorrect ? 'âœ“ æ­£è§£ã—ã¾ã—ãŸï¼' : 'âœ— ä¸æ­£è§£';
            
            // çµ±è¨ˆã‚’æ›´æ–°
            updateStats();
        }
        
        // å•é¡Œã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        function shuffleQuestions() {
            currentQuestions = [...wrongQuestions];
            for (let i = currentQuestions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [currentQuestions[i], currentQuestions[j]] = [currentQuestions[j], currentQuestions[i]];
            }
            displayQuestions();
        }
        
        // å¾©ç¿’ã®å›ç­”ã‚’ãƒªã‚»ãƒƒãƒˆ
        function resetReviewAnswers() {
            if (confirm('å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã®å›ç­”ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿå­¦ç¿’å±¥æ­´ã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
                wrongQuestions.forEach(item => {
                    const history = StudyHistory.getHistory();
                    if (history[item.category] && history[item.category].questions[item.questionIndex]) {
                        // é–“é•ãˆãŸå•é¡Œã¨ã—ã¦æ®‹ã™ï¼ˆisCorrectã‚’falseã«æˆ»ã™ï¼‰
                        history[item.category].questions[item.questionIndex].isCorrect = false;
                        StudyHistory.saveHistory(history);
                    }
                });
                loadWrongQuestions();
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«é–“é•ãˆãŸå•é¡Œã‚’èª­ã¿è¾¼ã‚€
        document.addEventListener('DOMContentLoaded', loadWrongQuestions);
    </script>
</body>
</html>

